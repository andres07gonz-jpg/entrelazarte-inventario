<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Reportes y Estad√≠sticas - ENTRELAZARTE</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { 
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      padding: 20px;
      min-height: 100vh;
    }
    
    .container {
      max-width: 1400px;
      margin: 0 auto;
    }
    
    h1 {
      text-align: center;
      color: white;
      margin-bottom: 30px;
      font-size: 2.5em;
      text-shadow: 2px 2px 4px rgba(0,0,0,0.2);
    }
    
    .nav-buttons {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
      justify-content: center;
      flex-wrap: wrap;
    }
    
    .btn {
      padding: 12px 24px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-size: 16px;
      font-weight: 600;
      transition: all 0.3s ease;
      text-decoration: none;
      display: inline-block;
    }
    
    .btn-primary {
      background: #3498db;
      color: white;
    }
    
    .btn-primary:hover {
      background: #2980b9;
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(52, 152, 219, 0.4);
    }
    
    .btn-secondary {
      background: #95a5a6;
      color: white;
    }
    
    .btn-secondary:hover {
      background: #7f8c8d;
    }
    
    .btn.active {
      background: #27ae60;
      transform: scale(1.05);
    }
    
    .filters {
      background: white;
      padding: 20px;
      border-radius: 12px;
      margin-bottom: 20px;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    }
    
    .filters h3 {
      margin-bottom: 15px;
      color: #2c3e50;
    }
    
    .filter-group {
      display: flex;
      gap: 15px;
      flex-wrap: wrap;
      align-items: center;
    }
    
    .filter-group label {
      font-weight: 600;
      color: #34495e;
    }
    
    .filter-group input,
    .filter-group select {
      padding: 8px 12px;
      border: 2px solid #e0e0e0;
      border-radius: 6px;
      font-size: 14px;
    }
    
    .filter-group input:focus,
    .filter-group select:focus {
      outline: none;
      border-color: #3498db;
    }
    
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }
    
    .stat-card {
      background: white;
      padding: 25px;
      border-radius: 12px;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
      transition: transform 0.3s ease;
    }
    
    .stat-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 8px 15px rgba(0,0,0,0.2);
    }
    
    .stat-card h3 {
      color: #7f8c8d;
      font-size: 14px;
      margin-bottom: 10px;
      text-transform: uppercase;
      letter-spacing: 1px;
    }
    
    .stat-card .value {
      color: #2c3e50;
      font-size: 32px;
      font-weight: bold;
      margin-bottom: 5px;
    }
    
    .stat-card .subtitle {
      color: #95a5a6;
      font-size: 13px;
    }
    
    .chart-container {
      background: white;
      padding: 30px;
      border-radius: 12px;
      margin-bottom: 30px;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    }
    
    .chart-container h2 {
      color: #2c3e50;
      margin-bottom: 20px;
      font-size: 24px;
    }
    
    .chart-wrapper {
      position: relative;
      height: 400px;
    }
    
    table {
      width: 100%;
      background: white;
      border-radius: 12px;
      overflow: hidden;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
      margin-bottom: 30px;
    }
    
    thead {
      background: #34495e;
      color: white;
    }
    
    th, td {
      padding: 15px;
      text-align: left;
    }
    
    tbody tr:nth-child(even) {
      background: #f8f9fa;
    }
    
    tbody tr:hover {
      background: #e9ecef;
    }
    
    .loading {
      text-align: center;
      padding: 50px;
      color: white;
      font-size: 24px;
    }
    
    .no-data {
      text-align: center;
      padding: 50px;
      background: white;
      border-radius: 12px;
      color: #7f8c8d;
    }
    
    @media (max-width: 768px) {
      .stats-grid {
        grid-template-columns: 1fr;
      }
      
      .filter-group {
        flex-direction: column;
        align-items: stretch;
      }
      
      h1 {
        font-size: 1.8em;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>üìä Reportes y Estad√≠sticas</h1>
    
   <div class="nav-buttons">
  <a href="index.html" class="btn btn-secondary">‚Üê Volver al Inventario</a>
  <button class="btn btn-primary" onclick="exportarExcel()">üì• Exportar a Excel</button>
</div>

    
    <!-- Filtros -->
    <div class="filters">
      <h3>üîç Filtros</h3>
      <div class="filter-group">
        <label>Per√≠odo:</label>
        <select id="periodo" onchange="cambiarPeriodo()">
          <option value="dia">Hoy</option>
          <option value="semana">Esta Semana</option>
          <option value="mes" selected>Este Mes</option>
          <option value="a√±o">Este A√±o</option>
          <option value="personalizado">Personalizado</option>
        </select>
        
        <label>Desde:</label>
        <input type="date" id="fechaInicio" onchange="aplicarFiltros()">
        
        <label>Hasta:</label>
        <input type="date" id="fechaFin" onchange="aplicarFiltros()">
        
        <button class="btn btn-primary" onclick="aplicarFiltros()">Aplicar</button>
      </div>
    </div>
    
    <!-- Estad√≠sticas Generales -->
    <div class="stats-grid">
      <div class="stat-card">
        <h3>Total Ventas</h3>
        <div class="value" id="totalVentas">0</div>
        <div class="subtitle">transacciones</div>
      </div>
      
      <div class="stat-card">
        <h3>Ingresos Totales</h3>
        <div class="value" id="ingresosTotales">$0.00</div>
        <div class="subtitle">en el per√≠odo</div>
      </div>
      
      <div class="stat-card">
        <h3>Promedio por Venta</h3>
        <div class="value" id="promedioVenta">$0.00</div>
        <div class="subtitle">ticket promedio</div>
      </div>
      
      <div class="stat-card">
        <h3>Venta M√°xima</h3>
        <div class="value" id="ventaMaxima">$0.00</div>
        <div class="subtitle">mejor venta</div>
      </div>
    </div>
    
    <!-- Gr√°fica de Ventas Diarias -->
    <div class="chart-container">
      <h2>üìà Ventas por D√≠a</h2>
      <div class="chart-wrapper">
        <canvas id="ventasDiariasChart"></canvas>
      </div>
    </div>
    
    <!-- Gr√°fica Comparativa -->
    <div class="chart-container">
      <h2>üìä Comparativa de Per√≠odos</h2>
      <div class="filter-group" style="margin-bottom: 20px;">
        <label>Tipo de comparativa:</label>
        <select id="tipoComparativa" onchange="cargarComparativa()">
          <option value="mensual" selected>√öltimos 12 Meses</option>
          <option value="semanal">√öltimas 8 Semanas</option>
          <option value="anual">√öltimos 5 A√±os</option>
        </select>
      </div>
      <div class="chart-wrapper">
        <canvas id="comparativaChart"></canvas>
      </div>
    </div>
    
    <!-- Productos M√°s Vendidos -->
    <div class="chart-container">
      <h2>üèÜ Top 10 Productos M√°s Vendidos</h2>
      <div class="chart-wrapper">
        <canvas id="productosTopChart"></canvas>
      </div>
    </div>
    
    <!-- Tabla de Ventas Recientes -->
    <div class="chart-container">
      <h2>üìã Historial de Ventas</h2>
      <table id="ventasTable">
        <thead>
            <tr>
                <th>ID</th>
                <th>Fecha</th>
                <th>Total</th>
                <th>Recibido</th>
                <th>Cambio</th>
                <th>Items</th>
                <th>Ver</th>
                <th>Eliminar</th>
            </tr>
        </thead>
        <tbody id="ventasTableBody">
          <tr><td colspan="7" class="loading">Cargando...</td></tr>
        </tbody>
      </table>
    </div>
  </div>

  <script>
    let ventasDiariasChart = null;
    let comparativaChart = null;
    let productosTopChart = null;
    
    // Configurar fechas por defecto (√∫ltimo mes)
    function configurarFechasPorDefecto() {
      const hoy = new Date();
      const hace30dias = new Date();
      hace30dias.setDate(hace30dias.getDate() - 30);
      
      document.getElementById('fechaFin').valueAsDate = hoy;
      document.getElementById('fechaInicio').valueAsDate = hace30dias;
    }
    
    // Cambiar per√≠odo predefinido
    function cambiarPeriodo() {
      const periodo = document.getElementById('periodo').value;
      const hoy = new Date();
      let fechaInicio = new Date();
      
      if (periodo === 'dia') {
        fechaInicio = hoy;
      } else if (periodo === 'semana') {
        fechaInicio.setDate(hoy.getDate() - 7);
      } else if (periodo === 'mes') {
        fechaInicio.setDate(hoy.getDate() - 30);
      } else if (periodo === 'a√±o') {
        fechaInicio.setFullYear(hoy.getFullYear() - 1);
      } else {
        return; // personalizado
      }
      
      document.getElementById('fechaInicio').valueAsDate = fechaInicio;
      document.getElementById('fechaFin').valueAsDate = hoy;
      aplicarFiltros();
    }
    
    // Aplicar filtros y recargar datos
    function aplicarFiltros() {
      cargarEstadisticas();
      cargarComparativa();
      cargarVentas();
    }
    
    // Cargar estad√≠sticas
    async function cargarEstadisticas() {
      try {
        const fechaInicio = document.getElementById('fechaInicio').value + ' 00:00:00';
        const fechaFin = document.getElementById('fechaFin').value + ' 23:59:59';
        const periodo = document.getElementById('periodo').value;
        
        const res = await fetch(`/ventas/estadisticas?periodo=${periodo}&fecha_inicio=${fechaInicio}&fecha_fin=${fechaFin}`);
        const data = await res.json();
        
        // Actualizar tarjetas de estad√≠sticas
        document.getElementById('totalVentas').textContent = data.estadisticas.total_ventas || 0;
        document.getElementById('ingresosTotales').textContent = '$' + (data.estadisticas.ingresos_totales || 0).toFixed(2);
        document.getElementById('promedioVenta').textContent = '$' + (data.estadisticas.promedio_venta || 0).toFixed(2);
        document.getElementById('ventaMaxima').textContent = '$' + (data.estadisticas.venta_maxima || 0).toFixed(2);
        
        // Actualizar gr√°fica de ventas diarias
        actualizarGraficaVentasDiarias(data.ventas_diarias);
        
        // Actualizar gr√°fica de productos top
        actualizarGraficaProductosTop(data.productos_top);
        
      } catch (error) {
        console.error('Error al cargar estad√≠sticas:', error);
        alert('Error al cargar estad√≠sticas');
      }
    }
    
    // Actualizar gr√°fica de ventas diarias
    function actualizarGraficaVentasDiarias(datos) {
      const ctx = document.getElementById('ventasDiariasChart').getContext('2d');
      
      if (ventasDiariasChart) {
        ventasDiariasChart.destroy();
      }
      
      const labels = datos.map(d => d.fecha);
      const valores = datos.map(d => d.total_dia);
      
      ventasDiariasChart = new Chart(ctx, {
        type: 'line',
        data: {
          labels: labels,
          datasets: [{
            label: 'Ventas ($)',
            data: valores,
            borderColor: '#3498db',
            backgroundColor: 'rgba(52, 152, 219, 0.1)',
            tension: 0.4,
            fill: true
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              display: true,
              position: 'top'
            },
            tooltip: {
              callbacks: {
                label: function(context) {
                  return '$' + context.parsed.y.toFixed(2);
                }
              }
            }
          },
          scales: {
            y: {
              beginAtZero: true,
              ticks: {
                callback: function(value) {
                  return '$' + value;
                }
              }
            }
          }
        }
      });
    }
    
    // Cargar comparativa
    async function cargarComparativa() {
      try {
        const tipo = document.getElementById('tipoComparativa').value;
        const res = await fetch(`/ventas/comparativa?tipo=${tipo}`);
        const data = await res.json();
        
        actualizarGraficaComparativa(data.datos, tipo);
      } catch (error) {
        console.error('Error al cargar comparativa:', error);
      }
    }
    
    // Actualizar gr√°fica comparativa
    function actualizarGraficaComparativa(datos, tipo) {
      const ctx = document.getElementById('comparativaChart').getContext('2d');
      
      if (comparativaChart) {
        comparativaChart.destroy();
      }
      
      const labels = datos.map(d => d.periodo);
      const ventas = datos.map(d => d.num_ventas);
      const totales = datos.map(d => d.total_ventas);
      
      comparativaChart = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: labels,
          datasets: [
            {
              label: 'N√∫mero de Ventas',
              data: ventas,
              backgroundColor: 'rgba(52, 152, 219, 0.7)',
              borderColor: '#3498db',
              borderWidth: 2,
              yAxisID: 'y'
            },
            {
              label: 'Total en $ (l√≠nea)',
              data: totales,
              type: 'line',
              borderColor: '#27ae60',
              backgroundColor: 'rgba(39, 174, 96, 0.1)',
              borderWidth: 3,
              yAxisID: 'y1',
              tension: 0.4
            }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          interaction: {
            mode: 'index',
            intersect: false
          },
          plugins: {
            legend: {
              display: true,
              position: 'top'
            }
          },
          scales: {
            y: {
              type: 'linear',
              display: true,
              position: 'left',
              beginAtZero: true,
              title: {
                display: true,
                text: 'N√∫mero de Ventas'
              }
            },
            y1: {
              type: 'linear',
              display: true,
              position: 'right',
              beginAtZero: true,
              grid: {
                drawOnChartArea: false
              },
              title: {
                display: true,
                text: 'Total ($)'
              },
              ticks: {
                callback: function(value) {
                  return '$' + value;
                }
              }
            }
          }
        }
      });
    }
    
    // Actualizar gr√°fica de productos top
    function actualizarGraficaProductosTop(productos) {
      const ctx = document.getElementById('productosTopChart').getContext('2d');
      
      if (productosTopChart) {
        productosTopChart.destroy();
      }
      
      const labels = productos.map(p => p.NombreProducto);
      const cantidades = productos.map(p => p.cantidad_vendida);
      const colores = [
        '#3498db', '#e74c3c', '#27ae60', '#f39c12', '#9b59b6',
        '#1abc9c', '#34495e', '#e67e22', '#95a5a6', '#16a085'
      ];
      
      productosTopChart = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: labels,
          datasets: [{
            label: 'Cantidad Vendida',
            data: cantidades,
            backgroundColor: colores,
            borderColor: colores.map(c => c),
            borderWidth: 2
          }]
        },
        options: {
          indexAxis: 'y',
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              display: false
            }
          },
          scales: {
            x: {
              beginAtZero: true
            }
          }
        }
      });
    }
    
   // Cargar tabla de ventas
async function cargarVentas() {
  try {
    const res = await fetch('/ventas/?limite=50');
    const data = await res.json();
    
    const tbody = document.getElementById('ventasTableBody');
    tbody.innerHTML = '';
    
    if (data.ventas.length === 0) {
      tbody.innerHTML = '<tr><td colspan="8" class="no-data">No hay ventas registradas</td></tr>';
      return;
    }
    
    data.ventas.forEach(venta => {
      const fecha = new Date(venta.Fecha).toLocaleString('es-MX');
      const row = `
        <tr id="venta-${venta.VentaID}">
          <td>#${venta.VentaID}</td>
          <td>${fecha}</td>
          <td>$${parseFloat(venta.Total).toFixed(2)}</td>
          <td>$${parseFloat(venta.Recibido).toFixed(2)}</td>
          <td>$${parseFloat(venta.Cambio).toFixed(2)}</td>
          <td>${venta.NumeroItems} items</td>
          <td>
            <button class="btn btn-primary" style="padding: 6px 12px; font-size: 13px;" onclick="verDetalle(${venta.VentaID})">
              üëÅÔ∏è Ver
            </button>
          </td>
          <td>
            <button class="btn btn-danger" style="padding: 6px 12px; font-size: 13px;" onclick="confirmarEliminarVenta(${venta.VentaID})">
              üóëÔ∏è
            </button>
          </td>
        </tr>
      `;
      tbody.innerHTML += row;
    });
  } catch (error) {
    console.error('Error al cargar ventas:', error);
  }
}

// Confirmar eliminaci√≥n de venta con modal elegante
function confirmarEliminarVenta(ventaID) {
  // Crear modal de confirmaci√≥n
  const modal = document.createElement('div');
  modal.id = 'deleteModal';
  modal.style.cssText = `
    display: flex;
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.7);
    align-items: center;
    justify-content: center;
    z-index: 9999;
    animation: fadeIn 0.2s ease;
  `;
  
  modal.innerHTML = `
    <div style="
      background: white;
      padding: 30px;
      border-radius: 15px;
      max-width: 450px;
      box-shadow: 0 10px 40px rgba(0,0,0,0.3);
      animation: slideIn 0.3s ease;
    ">
      <h3 style="margin: 0 0 15px 0; color: #e74c3c; display: flex; align-items: center; gap: 10px;">
        ‚ö†Ô∏è Confirmar Eliminaci√≥n
      </h3>
      <p style="margin-bottom: 20px; color: #555; line-height: 1.6;">
        ¬øEst√°s seguro de que deseas eliminar la venta <strong>#${ventaID}</strong>?
        <br><br>
        <span style="background: #fff3cd; padding: 10px; border-radius: 6px; display: block; border-left: 4px solid #f39c12;">
          ‚ö° Esta acci√≥n restaurar√° el stock de los productos vendidos.
        </span>
      </p>
      
      <div style="margin-bottom: 15px;">
        <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #2c3e50;">
          üîê Contrase√±a de Administrador:
        </label>
        <input 
          type="password" 
          id="deletePassword" 
          placeholder="Ingresa tu contrase√±a"
          style="
            width: 100%;
            padding: 10px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 6px;
            font-size: 14px;
            box-sizing: border-box;
          "
        >
      </div>
      
      <div style="display: flex; gap: 10px; justify-content: flex-end;">
        <button 
          onclick="cerrarModalEliminar()"
          style="
            padding: 10px 20px;
            background: #95a5a6;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
          "
          onmouseover="this.style.background='#7f8c8d'"
          onmouseout="this.style.background='#95a5a6'"
        >
          Cancelar
        </button>
        <button 
          onclick="eliminarVenta(${ventaID})"
          style="
            padding: 10px 20px;
            background: #e74c3c;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
          "
          onmouseover="this.style.background='#c0392b'"
          onmouseout="this.style.background='#e74c3c'"
        >
          Eliminar Venta
        </button>
      </div>
    </div>
    
    <style>
      @keyframes fadeIn {
        from { opacity: 0; }
        to { opacity: 1; }
      }
      @keyframes slideIn {
        from { transform: translateY(-20px); opacity: 0; }
        to { transform: translateY(0); opacity: 1; }
      }
    </style>
  `;
  
  document.body.appendChild(modal);
  
  // Focus en el campo de contrase√±a
  setTimeout(() => document.getElementById('deletePassword').focus(), 100);
  
  // Permitir cerrar con ESC
  document.addEventListener('keydown', function escListener(e) {
    if (e.key === 'Escape') {
      cerrarModalEliminar();
      document.removeEventListener('keydown', escListener);
    }
  });
}

function cerrarModalEliminar() {
  const modal = document.getElementById('deleteModal');
  if (modal) {
    modal.style.animation = 'fadeOut 0.2s ease';
    setTimeout(() => modal.remove(), 200);
  }
}

// Eliminar venta
async function eliminarVenta(ventaID) {
  const password = document.getElementById('deletePassword').value;
  
  if (!password || password.trim() === '') {
    alert('‚ö†Ô∏è Por favor ingresa la contrase√±a de administrador');
    return;
  }
  
  try {
    const res = await fetch(`/ventas/${ventaID}/`, {
      method: 'DELETE',
      headers: {
        'x-admin-pass': password
      }
    });
    
    if (!res.ok) {
      const err = await res.json();
      alert('‚ùå ' + (err.error || 'Error al eliminar venta'));
      return;
    }
    
    // Animaci√≥n de eliminaci√≥n
    const row = document.getElementById(`venta-${ventaID}`);
    if (row) {
      row.style.animation = 'fadeOut 0.3s ease';
      setTimeout(() => row.remove(), 300);
    }
    
    cerrarModalEliminar();
    
    // Mostrar mensaje de √©xito
    mostrarNotificacion('‚úÖ Venta eliminada exitosamente. El stock ha sido restaurado.', 'success');
    
    // Recargar datos despu√©s de 1 segundo
    setTimeout(() => {
      cargarEstadisticas();
      cargarComparativa();
      cargarVentas();
    }, 1000);
    
  } catch (error) {
    console.error('Error:', error);
    alert('‚ùå Error de conexi√≥n al eliminar venta');
  }
}

// Funci√≥n para mostrar notificaciones elegantes
function mostrarNotificacion(mensaje, tipo = 'success') {
  const colores = {
    success: { bg: '#27ae60', icon: '‚úÖ' },
    error: { bg: '#e74c3c', icon: '‚ùå' },
    warning: { bg: '#f39c12', icon: '‚ö†Ô∏è' }
  };
  
  const config = colores[tipo] || colores.success;
  
  const notif = document.createElement('div');
  notif.style.cssText = `
    position: fixed;
    top: 20px;
    right: 20px;
    background: ${config.bg};
    color: white;
    padding: 15px 25px;
    border-radius: 8px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.3);
    z-index: 10000;
    animation: slideInRight 0.3s ease;
    max-width: 400px;
  `;
  notif.innerHTML = `<strong>${config.icon}</strong> ${mensaje}`;
  
  document.body.appendChild(notif);
  
  setTimeout(() => {
    notif.style.animation = 'slideOutRight 0.3s ease';
    setTimeout(() => notif.remove(), 300);
  }, 3000);
}
    
    // Ver detalle de venta
    async function verDetalle(ventaID) {
      try {
        const res = await fetch(`/ventas/${ventaID}/`);
        const data = await res.json();
        
        let detalleHTML = `
          <strong>Venta #${data.venta.VentaID}</strong><br>
          Fecha: ${new Date(data.venta.Fecha).toLocaleString('es-MX')}<br>
          Total: $${parseFloat(data.venta.Total).toFixed(2)}<br><br>
          <strong>Productos:</strong><br>
        `;
        
        data.items.forEach(item => {
          detalleHTML += `- ${item.NombreProducto} x${item.Cantidad} = $${parseFloat(item.Subtotal).toFixed(2)}<br>`;
        });
        
        alert(detalleHTML.replace(/<br>/g, '\n').replace(/<strong>|<\/strong>/g, ''));
      } catch (error) {
        console.error('Error al ver detalle:', error);
        alert('Error al cargar detalle de venta');
      }
    }
    
    // Exportar a Excel (simulado - genera CSV)
    function exportarExcel() {
      const fechaInicio = document.getElementById('fechaInicio').value;
      const fechaFin = document.getElementById('fechaFin').value;
      
      fetch(`/ventas/?limite=1000`)
        .then(res => res.json())
        .then(data => {
          let csv = 'ID,Fecha,Total,Recibido,Cambio,Items\n';
          
          data.ventas.forEach(venta => {
            csv += `${venta.VentaID},${venta.Fecha},${venta.Total},${venta.Recibido},${venta.Cambio},${venta.NumeroItems}\n`;
          });
          
          const blob = new Blob([csv], { type: 'text/csv' });
          const url = window.URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url;
          a.download = `ventas_${fechaInicio}_${fechaFin}.csv`;
          a.click();
        });
    }
    
    // Inicializar
    configurarFechasPorDefecto();
    cargarEstadisticas();
    cargarComparativa();
    cargarVentas();
  </script>
</body>
</html>